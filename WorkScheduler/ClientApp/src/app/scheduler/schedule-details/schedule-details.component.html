<h1>{{currentSchedule?.name}}</h1> 

<div style="text-align: left">
  <button type="button" (click)="openModal(add)" class="btn btn-success">Добавить мероприятие</button>
  <button type="button" (click)="openModal(generateDocConf)" class="btn btn-primary" >Сформировать документ</button>
  <button type="button" (click)="sendSchedule()" class="btn btn-info" >Отправить на мою почту</button>
  <button type="button" (click)="openModal(editScheduleModal)" class="btn btn-warning">Редактировать план</button>
</div>
<br/>

<table class="table">
  <thead>
    <tr>
      <th scope="col"><input type="checkbox" [(ngModel)]="selectedAll" (click)="selection()" /></th>
      <th scope="col">Дата</th>
      <th scope="col">Мероприятие</th>
      <th scope="col">Ответственные</th>
      <th scope="col">Форма подтверждения</th>
      <th scope="col">Статус</th>
      <th scope="col">Действия</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let action of actions" [class.freezed]="isActionFreezed(action)">
      <td><input type="checkbox" [disabled]="isActionFreezed(action)" [(ngModel)]="action.selected" (ngModelChange)="select()"/></td>
      <td>{{action.date | date : 'dd.MM.yyyy'}}</td>
      <td>{{action.name}}</td>
      <td>
        <span *ngFor="let user of action.responsibles" class="badge">
          {{user.lastName}} {{user.firstName[0]}}. {{user.surName[0]}}.
        </span> &nbsp;
      </td>
      <td>{{action.confirmationForm.name}}</td>
      <td>
        <span style="color: blue" *ngIf="action.status == 0">Новая запись</span>
        <span style="color: black" *ngIf="action.status == 1">На согласовании</span>
        <span style="color: mediumorchid" *ngIf="action.status == 2">Согласовано</span>
        <span style="color: green" *ngIf="action.status == 3">Утверждено</span>
        <span style="color: red" *ngIf="action.status == 4">Отклонено при согласовании</span>
        <span style="color: red" *ngIf="action.status == 5">Отклонено при утверждении</span>
      </td>
      <td>
        <div style="text-align: center">
          <a [class.disabledLink]="isActionFreezed(action)" title="Редактировать" href="javascript:void(0)" (click)="copy(action); openModal(edit);"><span style="color: purple" class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
          <a [class.disabledLink]="isActionFreezed(action)" title="Удалить" href="javascript:void(0)" (click)="delete(action)"><span style="color: red" class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<div *ngIf="checkRole(userState.currentUser?.state, 'Учитель') && !checkRole(userState.currentUser?.state, 'Администратор')" style="text-align: center">
  <button type="button" (click)="confirm()" class="btn btn-warning" >Отправить отмеченные мероприятия на согласование</button>
</div>

<div *ngIf="checkRole(userState.currentUser?.state, 'Администратор')" style="text-align: center">
  <button type="button" (click)="accept()" class="btn btn-warning">Отправить отмеченные мероприятия на утверждение</button>
</div>

<ng-template #add>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Добавить мероприятие</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Дата проведения:
    <input type="text"
           placeholder="Щелкните здесь для выбора"
           class="form-control"
           [(ngModel)]="selectedDate"
           AUTOCOMPLETE="off"
           [bsConfig]="bsConfig"
           bsDatepicker>
    <br>
    Конец (не обязательно):
    <input type="text"
           placeholder="Щелкните здесь для выбора. Это поле можно оставить пустым"
           class="form-control"
           [(ngModel)]="selectedEndDate"
           AUTOCOMPLETE="off"
           [bsConfig]="bsConfig"
           bsDatepicker>
    <br>
    Мероприятие:
    <input type="text" [(ngModel)]="selectedName" class="form-control" placeholder="Название мероприятия">
    <br>
    Ответственные:
    <ng-select [items]="allResponsibles | async"
               [disabled]="checkRole(userState.currentUser?.state, 'Учитель')"
               [multiple]="true"
               [closeOnSelect]="false"
               [searchable]="true"
               bindLabel="fullName"
               placeholder="Выберите как минимум одного"
               [(ngModel)]="selectedResponsibles">
    </ng-select>
    <br>
    Форма подтверждения выполнения:
    <ng-select [items]="allConfForms | async"
               bindLabel="name"
               bindValue="id"
               [(ngModel)]="selectedConfFormId"
               [clearable]="false">
    </ng-select>
    <br>

    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="createAction()" class="btn btn-success">Добавить</button>
    </div>

  </div>

</ng-template>

<ng-template #generateDocConf>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Сформировать документ?</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <p>В документ будут внесены только мероприятия, имеющие на данный момент статус <b style="color: green">утверждено</b>.</p>
    <p>Если ваши мероприятия не имеют статус утверждено и вам необходимо сформировать документ, отметьте галочками мероприятия, затем нажмите кнопку <b style="color: darkorange">"Отправить отмеченные мероприятия на согласование"</b> и дождитесь статуса утверждено. В случае отказа внесите необходимые изменения и отправьте снова</p>
    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="next()" class="btn btn-success">Продолжить</button>
    </div>
  </div>

</ng-template>

<ng-template #selectDate>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Укажите дату согласования и утверждения</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <p>Эти даты используются только для вставки в грифы документа</p> <br />
    Дата согласования:
    <input type="text"
           placeholder="Щелкните здесь для выбора"
           class="form-control"
           [(ngModel)]="confirmDate"
           AUTOCOMPLETE="off"
           [bsConfig]="bsConfig"
           bsDatepicker>
    <br>
    Дата утверждения:
    <input type="text"
           placeholder="Щелкните здесь для выбора"
           class="form-control"
           [(ngModel)]="acceptDate"
           AUTOCOMPLETE="off"
           [bsConfig]="bsConfig"
           bsDatepicker>
    <br>
    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="getDocument()" class="btn btn-success">Сформировать документ</button>
    </div>

  </div>

</ng-template>

<ng-template #edit>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Редактировать мероприятие</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Дата:
    <input type="text"
           placeholder="Щелкните здесь для выбора"
           class="form-control"
           [(ngModel)]="editedAction.date"
           AUTOCOMPLETE="off"
           [bsConfig]="bsConfig"
           bsDatepicker>
    <br>
    Мероприятие:
    <input type="text" [(ngModel)]="editedAction.name" class="form-control" placeholder="Название мероприятия">
    <br>
    Ответственные:
    <ng-select [items]="allResponsibles | async"
               [disabled]="checkRole(userState.currentUser?.state, 'Учитель')"
               [multiple]="true"
               [closeOnSelect]="false"
               [searchable]="true"
               bindLabel="fullName"
               placeholder="Выберите как минимум одного"
               [(ngModel)]="editedAction.responsibles">
    </ng-select>
    <br>
    Форма подтверждения выполнения:
    <ng-select [items]="allConfForms | async"
               bindLabel="name"
               bindValue="id"
               [(ngModel)]="editedAction.confirmationForm.id"
               [clearable]="false">
    </ng-select>
    <br>

    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="applyChanges()" class="btn btn-success">Сохранить</button>
    </div>

  </div>

</ng-template>

<ng-template #del>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Удалить мероприятие?</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Нет</button>
      <button type="button" (click)="some()" class="btn btn-success">Да</button>
    </div>
  </div>

</ng-template>

<ng-template #delSchedule>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Удалить план?</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Отменить действие будет невозможно. Продолжить?
    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Нет</button>
      <button type="button" (click)="deleteSchedule()" class="btn btn-success">Да</button>
    </div>
  </div>

</ng-template>

<ng-template #editScheduleModal>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Редактировать план</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Наименование:
    <input class="form-control" [(ngModel)]="editedSchedule.name" placeholder="Наименование">
    <br/>

    Направление деятельности:
    <ng-select [items]="allActivities"
               bindLabel="name"
               bindValue="id"
               [(ngModel)]="editedSchedule.activity.id"
               [clearable]="false">
    </ng-select>

    <br />

    Учебный год:
    <ng-select [items]="allAcademicYears"
               bindLabel="name"
               bindValue="id"
               [(ngModel)]="editedSchedule.academicYear.id"
               [clearable]="false">
    </ng-select>
    <br>


    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="modalRef.hide(); openModal(delSchedule)" class="btn btn-danger">Удалить план</button>
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="editSchedule()" class="btn btn-success">Сохранить</button>
    </div>

  </div>
</ng-template>

<p-toast [baseZIndex]="1000"></p-toast>
