<div class="top-container">
  <div>
    <h1>Моя циклограмма</h1>
  </div>
  
  <div>
    <button *ngIf="userState.assignedTickets.state && userState.assignedTickets.state.length > 0" style="margin-top: 20px;" type="button" (click)="openModal(assignedTasksModal)" class="btn btn-warning top-item"><span class="glyphicon glyphicon-bell"></span> Задания</button>
  </div>
</div>

<br />

<div class="top" style="text-align: left;">

  <input type="text"
         class="form-control top-item"
         [(ngModel)]="range"
         (ngModelChange)="loadData()"
         AUTOCOMPLETE="off"
         [bsConfig]="bsConfig"
         bsDaterangepicker
         placeholder="Выбрать период" 
         style="width: 300px; float: left;"> &nbsp;

  <button type="button" (click)="openModal(add)" class="btn btn-success top-item">Добавить запись</button>&nbsp;
  <button type="button" (click)="getDocument()" class="btn btn-primary top-item">Сформировать документ</button>&nbsp;
  <button type="button" (click)="sendTimeline()" class="btn btn-info top-item">Отправить на мою почту</button>
</div>

<br />

<div style="text-align: center; margin-top: 70px; font-style: italic;" *ngIf="!packs || packs?.length == 0"><span>Выберите период</span></div>

<div *ngFor="let pack of packs">
  <div class="date-box">
    <div style="float:left;"><h3>{{pack.dateToShow}}</h3> </div> <button class="btn btn-success add-date-btn" style="margin: 16px;" type="button" (click)="openModal(add, pack.date)"><span class="glyphicon glyphicon-plus"></span></button>&nbsp; <br />
  </div>
  <table class="table">
    <thead>
      <tr>
        <th scope="col" style="width: 5%">Время</th>
        <th scope="col" style="width: 30%">Наименование</th>
        <!--<th scope="col">Дата</th>-->
        <th scope="col" width="25%">Мероприятие</th>
        <th scope="col" width="30%">Комментарий</th>
        <th scope="col" width="5%">Действия</th>
      </tr>
    </thead>
    <tbody *ngFor="let timeGroup of pack?.timeGroups">
      <tr><td style="font-weight: 700; font-size:larger" colspan="6">{{timeGroup.hour}}:00 </td></tr>
      <tr *ngFor="let ticket of timeGroup.tickets" [class.done]="ticket.done" [class.important]="ticket.important">
        <td><span *ngIf="ticket.hours && ticket.minutes != 0">{{ticket.hours}}:{{ticket.minutes}}<span *ngIf="ticket.minutes == 0">0</span></span></td>
        <td>{{ticket.name}}</td>
        <!--<td>ticket.date | date : 'dd.MM.yyyy'</td>-->
        <td>
          <div *ngIf="ticket.action" [class.deleted-action]="ticket.action.isDeleted">
            <div class="inner-action-card c{{ticket.action.activity.color}}">
              <span>{{ticket.action.name}}</span>
              <br />
              <span *ngFor="let user of ticket.action.responsibles" class="badge">{{user.lastName}} {{user.firstName[0]}}. {{user.surName[0]}}</span>
              <br />
              ФП: {{ticket.action.confirmationForm.name}}
            </div>
          </div>
          <span style="color: darkgray; text-align: center;" *ngIf="!ticket.action"></span>
        </td>
        <td>{{ticket.comment}}</td>
        <td>
          <div style="text-align: center">
            <a title="Отметка &laquo;Выполнено&raquo;" href="javascript:void(0)" (click)="makeDone(ticket)"><span [class.gray]="!ticket.done" class="glyphicon glyphicon-ok" aria-hidden="true"></span></a>
            <a title="Отметка &laquo;Важно&raquo;" href="javascript:void(0)" (click)="makeImportant(ticket.id)"><span [class.gray]="!ticket.important" class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span></a>
            <a title="Редактировать" href="javascript:void(0)" (click)="copy(ticket); openModal(edit);"><span style="color: steelblue" class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
            <a title="Удалить" href="javascript:void(0)" (click)="delete(ticket)"><span style="color: red" class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<ng-template #edit>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Изменить запись в циклограмме</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div style="margin-top: -10px">
      Наименование:
      <input type="text" [(ngModel)]="newTicket.name" class="form-control" placeholder="Название записи">
    </div>

    <div>
      Дата:
      <input type="text"
             placeholder="Щелкните здесь для выбора"
             class="form-control"
             [(ngModel)]="newTicket.date"
             AUTOCOMPLETE="off"
             [bsConfig]="bsConfig"
             bsDatepicker>
    </div>
    <div>
      Время начала:
      <input type="text" [(ngModel)]="newTicket.hours" class="clock form-control" placeholder="ЧЧ"> :
      <input type="text" [(ngModel)]="newTicket.minutes" class="clock form-control" placeholder="ММ">
    </div>

    <div>
      Комментарий(не обязательно):
      <textarea [(ngModel)]="newTicket.comment" class="form-control" placeholder="Комментарий"></textarea>
    </div>

    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="saveTicket()" class="btn btn-success">Сохранить</button>
    </div>

  </div>

</ng-template>

<ng-template #add>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Создать запись в циклограмме</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div style="margin-top: -10px">
      Наименование:
      <input type="text" [(ngModel)]="newTicket.name" class="form-control" placeholder="Название записи">
    </div>

    <div>
      Дата:
      <input type="text"
             placeholder="Щелкните здесь для выбора"
             class="form-control"
             [(ngModel)]="newTicket.date"
             AUTOCOMPLETE="off"
             [bsConfig]="bsConfig"
             bsDatepicker>
    </div>

    <div>
      Время начала:
      <input type="text" [(ngModel)]="newTicket.hours" class="clock form-control" placeholder="ЧЧ"> :
      <input type="text" [(ngModel)]="newTicket.minutes" class="clock form-control" placeholder="ММ">
    </div>
    <br />

    <app-repeat (days)="setDays($event)" (dateTo)="setDateTo($event)" (repeatAction)="setRepeat($event)"></app-repeat>

    <div>
      Комментарий(не обязательно):
      <textarea [(ngModel)]="newTicket.comment" class="form-control" placeholder="Комментарий"></textarea>
    </div>

    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="addTicket()" class="btn btn-success">Сохранить</button>
    </div>

  </div>

</ng-template>

<ng-template #deleteAll>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Удалить все записи?</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <p>Было найдно ещё {{similarTickets.length}} записей похожих на	&laquo;{{currentTicket.name}}&raquo;</p>
    <p>Дата последней записи: {{similarTickets[similarTickets.length - 1].date | date : 'dd.MM.yyyy'}}</p>

    <a href="javascript:void(0)" (click)="showAllSimilar = !showAllSimilar"><span *ngIf="!showAllSimilar">Посмотреть</span><span *ngIf="showAllSimilar">Скрыть</span> все похожие записи</a>

    <div *ngIf="showAllSimilar" style="overflow-y: scroll; height:400px;">
      <p *ngFor="let t of similarTickets">
        {{t.date | date : 'dd.MM.yyyy'}} {{t.name}} {{t.comment}}
      </p>
    </div>

    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="deleteSimilar()" class="btn btn-danger">Удалить все похожие записи</button>
      <button type="button" (click)="deleteOne()" class="btn btn-success">Удалить только выбранную</button>
    </div>
  </div>
</ng-template>

<ng-template #assignedTasksModal>
  <div class="modal-header" style="border-bottom: none !important">
    <h4 class="modal-title pull-left">Задания</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <table class="table">
      <thead>
        <tr>
          <th scope="col" style="width: 1%"></th>
          <th scope="col" style="width: 15%">Дата</th>
          <th scope="col" style="width: 10%">Время</th>
          <th scope="col" style="width: 65%">Задание</th>
          <th scope="col" style="width: 9%; text-align: center">Действия</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of userState.assignedTickets.state" [class.expired]="false">
          <td><span placement="left" theme="light"  z-index="10000" [tooltip]="getTooltip(ticket)" style="color: skyblue" class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></td>
          <td><span *ngIf="ticket.date">{{ticket.date | date : 'dd.MM.yyyy'}}</span></td>
          <td><span *ngIf="ticket.hours">{{ticket.hours}}:{{ticket.minutes}}<span *ngIf="ticket.minutes < 10"></span>0</span></td>
          <td>{{ticket.name}}</td>
          <td style="text-align: center">
            <a title="Принять" href="javascript:void(0)" (click)="acceptTicket(ticket)"><span style="color: green" class="glyphicon glyphicon-pushpin" aria-hidden="true"></span></a>
            <a title="Отклонить" href="javascript:void(0)" (click)="declineTicket(ticket)"><span style="color: red" class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>        
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</ng-template>

<p-toast [baseZIndex]="1000"></p-toast>
