<div style="word-wrap: break-word;">
  <h1>Чек-лист: "{{checklist.name}}"</h1>
</div>

<div class="panel panel-default">
  <div class="panel-body">
    <div style="text-align: left">
      <button type="button" (click)="clear(); openModal(add)" class="btn btn-success"><span class="glyphicon glyphicon-plus"></span> Добавить задание</button>
    </div>
  </div>
</div>

<br />



<h6 *ngIf="checklist.tickets && checklist.tickets.length != 0" style="text-align: right">Страница {{currentPage}} из {{totalPages}}</h6>

<table class="table" *ngIf="true">
  <thead>
    <tr>
      <th scope="col" style="width: 8%">
        <a href="javascript:void(0)" style="text-decoration: unset; color: #333;" (click)="sort('Created')"><span *ngIf="sortProperty == 'Created'" style="font-size: 10px;"><span *ngIf="sortDirection == 0" class='glyphicon glyphicon-arrow-up'></span><span *ngIf="sortDirection == 1" class='glyphicon glyphicon-arrow-down'></span></span> Дата создания</a>
        <input [(ngModel)]="filter.created" (ngModelChange)="loadData(false)" type="text" class="form-control" />
      </th>
      <th scope="col" style="width: 8%">
        <a href="javascript:void(0)" style="text-decoration: unset; color: #333;" (click)="sort('Date')"><span *ngIf="sortProperty == 'Date'" style="font-size: 10px;"><span *ngIf="sortDirection == 0" class='glyphicon glyphicon-arrow-up'></span><span *ngIf="sortDirection == 1" class='glyphicon glyphicon-arrow-down'></span></span> Дата выполнения</a>
        <input [(ngModel)]="filter.date" (ngModelChange)="loadData(false)" type="text" class="form-control" />
      </th>
      <th scope="col" style="width: 5%; vertical-align: text-top; text-align: center">Время</th>
      <th scope="col" style="width: 25%; vertical-align: text-top; text-align: center">Наименование</th>
      <th scope="col" style="width: 25%; vertical-align: text-top; text-align: center">Комментарий</th>
      <th scope="col" style="width: 15%; vertical-align: text-top; text-align: center">Кому назначена</th>
      <th scope="col" style="width: 7%; vertical-align: text-top; text-align: center">Статус</th>
      <th scope="col" style="width: 7%; vertical-align: text-top; text-align: center">Действия</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let ticket of checklist.tickets"
        [class.blue]="ticket.status == 1"
        [class.red]="ticket.isExpiered && ticket.status != 3"
        [class.yellow]="ticket.status == 2"
        [class.green]="ticket.status == 4">
      <td>{{ticket.created | date : 'dd.MM.yyyy'}}</td>
      <td>{{ticket.date | date : 'dd.MM.yyyy'}}</td>
      <td><span>{{ticket.hours}}:{{ticket.minutes}}<span *ngIf="ticket.minutes == 0">0</span></span></td>
      <td>
        <a style="color: black" href="javascript:void(0)" (click)="openDetails(ticket, detailsModal)">{{ticket.name}}</a>
      </td>
      <td>{{ticket.comment}}</td>
      <td>
        <span *ngIf="ticket.user.firstName" class="badge">
          {{ticket.user.lastName}} {{ticket.user.firstName[0]}}. {{ticket.user.surName[0]}}.
        </span>
      </td>
      <td>
        <span *ngIf="ticket.status == 0">Не назначено</span>
        <span *ngIf="ticket.status == 1">Назначено</span>
        <span *ngIf="ticket.status == 2">Принято</span>
        <span *ngIf="ticket.status == 3">Отклонено</span>
        <span *ngIf="ticket.status == 4">Готово</span>
      </td>
      <td>
        <div style="text-align: center">
          <a title="Редактировать" href="javascript:void(0)" (click)="copy(ticket); openModal(edit)">
            <span style="color: purple" class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
          </a>
          <a title="Удалить" href="javascript:void(0)" (click)="delete(ticket)">
            <span style="color: red"
                  class="glyphicon glyphicon-remove" aria-hidden="true"></span>
          </a>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<div style="text-align: center; margin-top: 50px; font-style: italic;"
     *ngIf="!checklist.tickets || checklist.tickets.length == 0"><span>Заданий нет</span></div>

<div style="text-align: center;">
  <pagination [boundaryLinks]="boundaryLinks()" firstText="В начало" lastText="В конец" nextText="Далее" previousText="Назад" [totalItems]="totalItemCount" [(ngModel)]="currentPage" (pageChanged)="currentPage = $event.page; loadData(); scrollToTop()" [maxSize]="5" [itemsPerPage]="15"></pagination>
</div>

<ng-template #detailsModal>
    <div class="modal-header">
      <h4 class="modal-title pull-left">Детали задания</h4>
      <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
        <div>
          <h5>Задание: </h5> 
          <p>{{newTicket.name}}</p>
          <br/>
          <h5>Ваши вложения:</h5>
          <div *ngIf="newTicket.inFiles.length == 0" style="text-align: center; margin-top: 25px; margin-bottom: 10px; font-style: italic;"><span>Вы пока не оставили ни одного вложения</span></div>
            <table class="table" *ngIf="newTicket.inFiles.length != 0">
                <thead>
                  <tr>
                    <th scope="col" style="width: 80%">Файл</th>
                    <th scope="col" style="width: 10%">Размер</th>
                    <th scope="col" style="width: 10%; text-align: center">Действия</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let file of newTicket.inFiles">
                    <td>
                        <i *ngIf="file.extension == 'doc' || file.extension == 'docx'" class="fa fa-file-word-o" aria-hidden="true" style="color: blue"></i>
                        <i *ngIf="file.extension == 'xls' || file.extension == 'xlsx'" class="fa fa-file-excel-o" aria-hidden="true" style="color: green"></i>
                        <i *ngIf="file.extension == 'ppt' || file.extension == 'pptx'" class="fa fa-file-powerpoint-o" aria-hidden="true" style="color: orange"></i>
                        <i *ngIf="file.extension == 'pdf'" class="fa fa-file-pdf-o" aria-hidden="true" style="color: red"></i>
                        <i *ngIf="file.extension == 'zip' || file.extension == 'rar'" class="fa fa-file-archive-o" aria-hidden="true" style="color: dimgray"></i>
                        <i *ngIf="file.extension == 'png' || file.extension == 'jpg' || file.extension == 'jpeg'" class="fa fa-file-image-o" aria-hidden="true" style="color: purple"></i>
                        <i *ngIf="file.extension != 'doc'
                           && file.extension != 'docx'
                           && file.extension != 'xls'
                           && file.extension != 'xlsx'
                           && file.extension != 'ppt'
                           && file.extension != 'pptx'
                           && file.extension != 'pdf'
                           && file.extension != 'zip'
                           && file.extension != 'rar'
                           && file.extension != 'png'
                           && file.extension != 'jpg'
                           && file.extension != 'jpeg'"
                           class="fa fa-file-o" aria-hidden="true"></i>
                           {{file.name}}
                    </td>
                    <td>{{file.sizeMb}} Мб</td>
                    <td style="text-align: center">
                      <a title="Скачать" (click)="downloadFile(file.id)" href="javascript:void(0)"><span style="color: green" class="glyphicon glyphicon-save" aria-hidden="true"></span></a>
                      <a title="Удалить" href="javascript:void(0)" (click)="deleteFileBinding(file, newTicket)"><span style="color: red" class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
                    </td>
                  </tr>
                </tbody>
              </table>

              Добавить вложения:
              <div>
                  <kendo-upload [saveUrl]="fileUploadUrl"
                                [removeUrl]="fileRemoveUrl"
                                (upload)="uploadEventHandler($event)"
                                (remove)="removeEventHandler($event)"
                                (success)="uploaded($event)">
                    <kendo-upload-messages select="Открыть окно выбора файлов"
                                           uploadSelectedFiles="Загрузить выбранные файлы"
                                           clearSelectedFiles="Удалить выбранные файлы">
                    </kendo-upload-messages>
                  </kendo-upload>
              </div>
        </div>

        <br/>

        <div>
            <h5>Ответный комментарий:</h5>
            <p>{{newTicket.responseComment}}</p>
        </div>

        <br/>

        <div>
            <h5>Ответные вложения:</h5>
            <div *ngIf="newTicket.outFiles.length == 0" style="text-align: center; margin-top: 20px; margin-bottom: 10px; font-style: italic;"><span>Вам пока не оставляли ответных вложений для этого задания</span></div>
              <table class="table" *ngIf="newTicket.outFiles.length != 0">
                  <thead>
                    <tr>
                      <th scope="col" style="width: 80%">Файл</th>
                      <th scope="col" style="width: 10%">Размер</th>
                      <th scope="col" style="width: 10%; text-align: center">Действия</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let file of newTicket.outFiles">
                      <td>
                          <i *ngIf="file.extension == 'doc' || file.extension == 'docx'" class="fa fa-file-word-o" aria-hidden="true" style="color: blue"></i>
                          <i *ngIf="file.extension == 'xls' || file.extension == 'xlsx'" class="fa fa-file-excel-o" aria-hidden="true" style="color: green"></i>
                          <i *ngIf="file.extension == 'ppt' || file.extension == 'pptx'" class="fa fa-file-powerpoint-o" aria-hidden="true" style="color: orange"></i>
                          <i *ngIf="file.extension == 'pdf'" class="fa fa-file-pdf-o" aria-hidden="true" style="color: red"></i>
                          <i *ngIf="file.extension == 'zip' || file.extension == 'rar'" class="fa fa-file-archive-o" aria-hidden="true" style="color: dimgray"></i>
                          <i *ngIf="file.extension == 'png' || file.extension == 'jpg' || file.extension == 'jpeg'" class="fa fa-file-image-o" aria-hidden="true" style="color: purple"></i>
                          <i *ngIf="file.extension != 'doc'
                             && file.extension != 'docx'
                             && file.extension != 'xls'
                             && file.extension != 'xlsx'
                             && file.extension != 'ppt'
                             && file.extension != 'pptx'
                             && file.extension != 'pdf'
                             && file.extension != 'zip'
                             && file.extension != 'rar'
                             && file.extension != 'png'
                             && file.extension != 'jpg'
                             && file.extension != 'jpeg'"
                             class="fa fa-file-o" aria-hidden="true"></i>
                             {{file.name}}
                      </td>
                      <td>{{file.sizeMb}} Мб</td>
                      <td style="text-align: center">
                        <a title="Скачать" (click)="downloadFile(file.id)" href="javascript:void(0)"><span style="color: green" class="glyphicon glyphicon-save" aria-hidden="true"></span></a>
                      </td>
                    </tr>
                  </tbody>
                </table>
          </div>
  
        
          <div style="text-align:center; margin-top: 15px;">
            <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
            <button type="button" (click)="saveReply()" class="btn btn-success">Сохранить</button>
          </div>
      </div>
  </ng-template>


<ng-template #add>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Создать задание</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div style="margin-top: -10px">
      Наименование:
      <input type="text" [(ngModel)]="newTicket.name" class="form-control" placeholder="Название задания">
    </div>
    <br />
    <div>
      Дата выполнения:
      <input type="text" placeholder="Щелкните здесь для выбора" class="form-control" [(ngModel)]="newTicket.date"
             AUTOCOMPLETE="off" [bsConfig]="bsConfig" bsDatepicker>
    </div>

    <div style="margin-top: 20px;">
      Время начала:
      <input type="text" [(ngModel)]="newTicket.hours" class="clock form-control" placeholder="ЧЧ"> :
      <input type="text" [(ngModel)]="newTicket.minutes" class="clock form-control" placeholder="ММ">
    </div>
    <br />

    Кому назначено:
    <ng-select [items]="responsibles | async"
               [multiple]="true"
               [closeOnSelect]="false"
               [searchable]="true"
               bindLabel="fullName"
               bindValue="id"
               placeholder="Вы можете сделать выбор позже"
               [(ngModel)]="newTicket.userIdsToAssignTicket">
    </ng-select>
    <br />
    <div>
      Комментарий:
      <textarea [(ngModel)]="newTicket.comment" class="form-control" placeholder="Комментарий"></textarea>
    </div>
    <br />

    <div>
      Вложения:
      <kendo-upload [saveUrl]="fileUploadUrl"
                    [removeUrl]="fileRemoveUrl"
                    (upload)="uploadEventHandler($event)"
                    (remove)="removeEventHandler($event)"
                    (success)="uploaded($event)">
        <kendo-upload-messages select="Открыть окно выбора файлов"
                               uploadSelectedFiles="Загрузить выбранные файлы"
                               clearSelectedFiles="Удалить выбранные файлы">
        </kendo-upload-messages>
      </kendo-upload>
    </div>

    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="addTicket(null)" class="btn btn-success">Сохранить</button>
    </div>

  </div>
</ng-template>

<ng-template #edit>
  <div class="modal-header">
    <h4 class="modal-title pull-left">Изменить задание</h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div style="margin-top: -10px">
      Наименование:
      <input type="text" [(ngModel)]="newTicket.name" class="form-control" placeholder="Название записи">
    </div>
    <br />
    <div>
      Дата выполнения:
      <input type="text"
             placeholder="Щелкните здесь для выбора"
             class="form-control"
             [(ngModel)]="newTicket.date"
             AUTOCOMPLETE="off"
             [bsConfig]="bsConfig"
             bsDatepicker>
    </div>
    <br />
    <div>
      Время начала:
      <input type="text" [(ngModel)]="newTicket.hours" class="clock form-control" placeholder="ЧЧ"> :
      <input type="text" [(ngModel)]="newTicket.minutes" class="clock form-control" placeholder="ММ">
    </div>

    <br />

    Кому назначено:
    <ng-select [items]="responsibles | async"
               [multiple]="false" [closeOnSelect]="true" [searchable]="true" bindLabel="fullName"
               placeholder="Выберите только одного" [(ngModel)]="newTicket.user">
    </ng-select>
    <br />

    <div>
      Комментарий(не обязательно):
      <textarea [(ngModel)]="newTicket.comment" class="form-control" placeholder="Комментарий"></textarea>
    </div>
    <br />
    <div style="text-align:center; margin-top: 15px;">
      <button type="button" (click)="closeModal()" class="btn btn-danger">Отмена</button>
      <button type="button" (click)="saveTicket()" class="btn btn-success">Сохранить</button>
    </div>


  </div>

</ng-template>

<p-toast [baseZIndex]="1000"></p-toast>
